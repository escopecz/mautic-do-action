name: Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Generate unique test name
        id: test-name
        run: |
          # Create unique name with GitHub run number
          TEST_NAME="mautic-test-${{ github.run_number }}"
          echo "test-name=$TEST_NAME" >> $GITHUB_OUTPUT
          echo "🏷️ Test VPS name: $TEST_NAME"
        
      - name: Deploy Mautic (Test Action)
        id: deploy
        uses: ./
        with:
          vps-name: ${{ steps.test-name.outputs.test-name }}
          vps-size: 's-1vcpu-1gb'
          vps-region: 'nyc1'
          email: 'test@mautic-test.local'
          mautic-password: ${{ secrets.TEST_MAUTIC_PASSWORD }}
          mysql-password: ${{ secrets.TEST_MYSQL_PASSWORD }}
          mysql-root-password: ${{ secrets.TEST_MYSQL_ROOT_PASSWORD }}
          digitalocean-token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Show deployment results
        run: |
          echo "🎉 Deployment completed successfully!"
          echo "VPS IP: ${{ steps.deploy.outputs.vps-ip }}"
          echo "Mautic URL: ${{ steps.deploy.outputs.mautic-url }}"
          
      - name: Test SSH access and container status
        run: |
          echo "🔐 Testing SSH access and verifying containers..."
          VPS_IP="${{ steps.deploy.outputs.vps-ip }}"
          
          if [ -z "$VPS_IP" ]; then
            echo "❌ VPS IP not available from deployment outputs"
            exit 1
          fi
          
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Test SSH and Docker status
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$VPS_IP << 'EOF'
            echo "✅ SSH connection successful"
            
            # Check Docker containers
            echo "🐳 Checking Docker containers..."
            docker-compose ps
            
            # Check Mautic logs
            echo "📋 Recent Mautic logs:"
            docker-compose logs --tail=10 mautic
            
            # Check disk usage
            echo "💾 Disk usage:"
            df -h /
          EOF
          
          # Cleanup SSH key
          rm -f ~/.ssh/id_rsa
          echo "✅ SSH test completed successfully"
          
      - name: Cleanup test droplet
        if: always()
        run: |
          echo "🧹 Cleaning up test droplet..."
          TEST_NAME="${{ steps.test-name.outputs.test-name }}"
          
          # Install doctl
          doctl auth init --access-token "${{ secrets.DIGITALOCEAN_TOKEN }}"
          
          # Delete the test droplet
          if doctl compute droplet list | grep -q "$TEST_NAME"; then
            echo "Deleting droplet: $TEST_NAME"
            doctl compute droplet delete "$TEST_NAME" --force
            echo "✅ Test droplet deleted"
          else
            echo "ℹ️ Test droplet not found (may have failed to create)"
          fi
          
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            ${{ steps.deploy.outputs.deployment-log }}
          retention-days: 7