name: Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Generate unique test name
        id: test-name
        run: |
          # Create unique name with GitHub run number
          TEST_NAME="mautic-test-${{ github.run_number }}"
          echo "test-name=$TEST_NAME" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è Test VPS name: $TEST_NAME"
        
      - name: Deploy Mautic (Test Action)
        id: deploy
        uses: ./
        with:
          vps-name: ${{ steps.test-name.outputs.test-name }}
          vps-size: 's-1vcpu-1gb'
          vps-region: 'nyc1'
          email: 'test@mautic-test.local'
          mautic-password: ${{ secrets.TEST_MAUTIC_PASSWORD }}
          mysql-password: ${{ secrets.TEST_MYSQL_PASSWORD }}
          mysql-root-password: ${{ secrets.TEST_MYSQL_ROOT_PASSWORD }}
          digitalocean-token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Show deployment results
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "VPS IP: ${{ steps.deploy.outputs.vps-ip }}"
          echo "Mautic URL: ${{ steps.deploy.outputs.mautic-url }}"
          echo "‚úÖ Integration test passed - Mautic deployment and validation completed"
          
      - name: Cleanup test droplet
        if: always()
        run: |
          echo "üßπ Cleaning up test droplet..."
          TEST_NAME="${{ steps.test-name.outputs.test-name }}"
          
          # Install doctl
          doctl auth init --access-token "${{ secrets.DIGITALOCEAN_TOKEN }}"
          
          # Delete the test droplet
          if doctl compute droplet list | grep -q "$TEST_NAME"; then
            echo "Deleting droplet: $TEST_NAME"
            doctl compute droplet delete "$TEST_NAME" --force
            echo "‚úÖ Test droplet deleted"
          else
            echo "‚ÑπÔ∏è Test droplet not found (may have failed to create)"
          fi
          
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            ./setup-dc.log
          if-no-files-found: warn
          retention-days: 7